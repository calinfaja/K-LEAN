{
  "project": {
    "name": "k-lean",
    "package_name": "kln-ai",
    "version": "1.0.0b6",
    "description": "Multi-model code review and knowledge capture system for Claude Code",
    "generated": "2026-01-09",
    "python_version": ">=3.9",
    "license": "Apache-2.0",
    "cross_platform": true
  },
  "entry_points": {
    "kln": "src/klean/cli.py:main",
    "kln-smol": "src/klean/smol/cli.py:main",
    "kln-hook-session": "src/klean/hooks.py:session_start",
    "kln-hook-prompt": "src/klean/hooks.py:prompt_handler",
    "kln-hook-bash": "src/klean/hooks.py:post_bash",
    "kln-hook-web": "src/klean/hooks.py:post_web"
  },
  "core_modules": {
    "cli": {
      "path": "src/klean/cli.py",
      "exports": ["main", "init", "install", "uninstall", "status", "doctor", "start", "stop", "multi", "model", "provider", "admin"],
      "command_structure": {
        "root": ["init", "install", "uninstall", "start", "stop", "status", "doctor", "multi"],
        "model_subgroup": ["list", "add", "remove", "test"],
        "provider_subgroup": ["list", "add", "set-key", "remove"],
        "admin_subgroup": ["sync", "debug", "test"]
      },
      "purpose": "Primary CLI with Click commands, organized into root + 3 subgroups"
    },
    "hooks": {
      "path": "src/klean/hooks.py",
      "exports": ["session_start", "prompt_handler", "post_bash", "post_web"],
      "purpose": "Cross-platform Python hook entry points (read JSON stdin, output JSON stdout)"
    },
    "reviews": {
      "path": "src/klean/reviews.py",
      "exports": ["quick_review", "consensus_review", "second_opinion", "ReviewResult", "ConsensusResult"],
      "purpose": "Async code review via httpx with thinking model support"
    },
    "platform": {
      "path": "src/klean/platform.py",
      "exports": ["spawn_background", "kill_process_tree", "is_process_running", "get_config_dir", "get_runtime_dir", "get_kb_port_file", "cleanup_stale_files"],
      "purpose": "Cross-platform paths (platformdirs) and process management (psutil)"
    },
    "config_generator": {
      "path": "src/klean/config_generator.py",
      "exports": ["generate_litellm_config", "load_config_yaml", "merge_models_into_config", "add_model_to_config", "remove_model_from_config"],
      "purpose": "LiteLLM configuration generation with non-destructive merging"
    },
    "discovery": {
      "path": "src/klean/discovery.py",
      "exports": ["list_models", "get_model", "is_available", "clear_cache"],
      "purpose": "Dynamic model discovery from LiteLLM proxy"
    },
    "model_utils": {
      "path": "src/klean/model_utils.py",
      "exports": ["extract_model_name", "parse_model_id", "is_thinking_model"],
      "purpose": "Model name extraction, parsing, and thinking model detection"
    },
    "model_defaults": {
      "path": "src/klean/model_defaults.py",
      "exports": ["get_nanogpt_models", "get_openrouter_models"],
      "purpose": "Default model configurations for each provider"
    }
  },
  "smol_system": {
    "path": "src/klean/smol/",
    "modules": {
      "executor": {"exports": ["SmolKLNExecutor"], "purpose": "Single agent execution with tool use"},
      "orchestrator": {"exports": ["SmolKLNOrchestrator", "quick_orchestrate"], "purpose": "Multi-agent coordination"},
      "memory": {"exports": ["AgentMemory", "SessionMemory", "MemoryEntry"], "purpose": "Context management and KB integration"},
      "tools": {"exports": ["read_file", "grep", "search_files", "get_default_tools"], "purpose": "Agent tools for code analysis"},
      "models": {"purpose": "LiteLLM model wrapper, thinking model support"},
      "loader": {"exports": ["parse_agent_file", "load_agent", "list_available_agents"], "purpose": "Agent definition loading from markdown"},
      "context": {"purpose": "Git context extraction (status, diff, log)"},
      "reflection": {"purpose": "Agent self-reflection and retry"},
      "async_executor": {"purpose": "Background async execution"},
      "task_queue": {"purpose": "Persistent task queue"},
      "mcp_tools": {"purpose": "MCP tool integration"}
    }
  },
  "slash_commands": {
    "kln:quick": {"file": "data/commands/kln/quick.md", "purpose": "Fast single-model review (~30s)"},
    "kln:multi": {"file": "data/commands/kln/multi.md", "purpose": "Multi-model consensus (~60s)"},
    "kln:agent": {"file": "data/commands/kln/agent.md", "purpose": "SmolKLN specialist agents (~2min)"},
    "kln:rethink": {"file": "data/commands/kln/rethink.md", "purpose": "Contrarian debugging (4 techniques)"},
    "kln:learn": {"file": "data/commands/kln/learn.md", "purpose": "Context-aware learning extraction"},
    "kln:remember": {"file": "data/commands/kln/remember.md", "purpose": "End-of-session capture"},
    "kln:doc": {"file": "data/commands/kln/doc.md", "purpose": "Documentation generation"},
    "kln:status": {"file": "data/commands/kln/status.md", "purpose": "System status"},
    "kln:help": {"file": "data/commands/kln/help.md", "purpose": "Command reference"}
  },
  "hooks": {
    "note": "Hooks are Python entry points (cross-platform), not shell scripts",
    "protocol": "Read JSON stdin, output JSON stdout. Exit 0=success, 2=block",
    "session-start": {"entry_point": "kln-hook-session", "trigger": "SessionStart", "purpose": "Auto-start LiteLLM + KB server"},
    "user-prompt": {"entry_point": "kln-hook-prompt", "trigger": "UserPromptSubmit", "keywords": ["FindKnowledge", "SaveInfo", "InitKB", "asyncReview", "asyncConsensus"]},
    "post-bash": {"entry_point": "kln-hook-bash", "trigger": "PostToolUse:Bash", "purpose": "Git timeline logging"},
    "post-web": {"entry_point": "kln-hook-web", "trigger": "PostToolUse:Web*", "purpose": "Auto-capture web content"}
  },
  "agents": {
    "code-reviewer": {"file": "data/agents/code-reviewer.md", "specialty": "OWASP, SOLID, code quality"},
    "security-auditor": {"file": "data/agents/security-auditor.md", "specialty": "Vulnerabilities, auth, crypto"},
    "debugger": {"file": "data/agents/debugger.md", "specialty": "Root cause analysis"},
    "performance-engineer": {"file": "data/agents/performance-engineer.md", "specialty": "Profiling, optimization"},
    "rust-expert": {"file": "data/agents/rust-expert.md", "specialty": "Ownership, lifetimes, unsafe"},
    "c-pro": {"file": "data/agents/c-pro.md", "specialty": "C99/C11, POSIX, embedded"},
    "arm-cortex-expert": {"file": "data/agents/arm-cortex-expert.md", "specialty": "ARM MCU, real-time"},
    "orchestrator": {"file": "data/agents/orchestrator.md", "specialty": "Multi-agent coordination"}
  },
  "knowledge_db": {
    "storage": ".knowledge-db/",
    "backend": "fastembed-hybrid",
    "models": {
      "dense": "BAAI/bge-small-en-v1.5",
      "sparse": "Qdrant/bm42-all-minilm-l6-v2-attentions",
      "reranker": "Xenova/ms-marco-MiniLM-L-6-v2"
    },
    "search_pipeline": ["dense", "sparse", "rrf_fusion", "reranking"],
    "server": {
      "type": "tcp_localhost",
      "port": "14000 + hash_offset",
      "features": ["server-owned writes", "immediate indexing", "add command"]
    },
    "scripts": {
      "server": "data/scripts/knowledge-server.py",
      "capture": "data/scripts/knowledge-capture.py",
      "core": "data/scripts/knowledge_db.py",
      "utils": "data/scripts/kb_utils.py"
    }
  },
  "tests": {
    "framework": "pytest",
    "path": "tests/unit/",
    "key_files": [
      "test_platform.py",
      "test_hooks.py",
      "test_reviews.py",
      "test_knowledge_server.py",
      "test_cli_integration.py",
      "test_discovery.py",
      "test_loader.py"
    ]
  },
  "dependencies": {
    "core": ["click>=8.0.0", "rich>=13.0.0", "pyyaml>=6.0.0", "httpx>=0.27.0", "psutil>=5.9.0", "platformdirs>=4.0.0"],
    "knowledge": ["fastembed>=0.3.0", "numpy>=1.24.0"],
    "agents": ["smolagents[litellm]>=1.17.0", "ddgs>=6.0.0", "markdownify>=0.11.0", "lizard>=1.17.0"],
    "optional": {
      "telemetry": ["arize-phoenix>=4.0", "opentelemetry-sdk"],
      "agent-sdk": ["anthropic>=0.34.0,<1.0.0"],
      "dev": ["pytest", "black", "ruff"]
    }
  },
  "key_patterns": [
    "Cross-platform first: Python entry points, TCP IPC, platformdirs",
    "Dynamic model discovery from LiteLLM (no hardcoding)",
    "Server-owned writes: KB entries immediately searchable via TCP",
    "Thinking model handling: Both content and reasoning_content supported",
    "Agent definitions: YAML frontmatter + markdown system prompt",
    "Per-project isolation: .knowledge-db/ and .claude/kln/ per repo"
  ],
  "documentation": {
    "overview": "docs/architecture/OVERVIEW.md",
    "components": "docs/architecture/COMPONENTS.md",
    "development": "docs/architecture/DEVELOPMENT.md",
    "migration": "docs/shell-to-python-migration.md"
  }
}
